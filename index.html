<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>20nagar Food Xpress</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{--brand:#ff9933}
body{margin:0;font-family:Arial,sans-serif;background:#f7f7f7}
.page{display:none;min-height:100vh;background:#fff}
.page.active{display:block}

.header{padding:10px;border-bottom:1px solid #ddd;text-align:center}
.header img{height:42px}

.topbar{padding:12px;border-bottom:1px solid #ddd;cursor:pointer}
.content{padding:14px;padding-bottom:90px}

.search{width:100%;padding:10px;margin:10px 0}

.restaurant{
  display:flex;gap:12px;align-items:center;
  padding:12px;border:1px solid #ddd;margin-bottom:10px
}
.restaurant.open{cursor:pointer}
.restaurant.closed{opacity:.6}

.restaurant img{
  width:48px;height:48px;border-radius:6px;object-fit:cover
}
.rest-info{flex:1}
.rest-name{font-weight:600}
.rest-status{font-size:12px;margin-top:4px}
.open-text{color:green}
.closed-text{color:red}

.category{font-weight:bold;font-size:18px;margin-top:20px}

.item,.cart-item{
  display:flex;justify-content:space-between;align-items:flex-start;
  padding:10px 0;border-bottom:1px solid #eee
}
.item-name{font-weight:600}
.item-desc{font-size:13px;color:#777;margin-top:2px}

.qty{display:flex;align-items:center;gap:8px}
.qty button{
  width:28px;height:28px;border:none;
  background:var(--brand);color:#fff;font-size:18px
}

.cart-bar{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--brand);color:#fff;
  padding:12px;display:none;
  justify-content:space-between;cursor:pointer
}

.bill div{display:flex;justify-content:space-between;margin-bottom:6px}
.bill .total{font-weight:bold;font-size:18px}
.note{font-size:12px;color:#666;margin-top:8px}

button.primary{
  width:100%;padding:12px;background:var(--brand);
  color:#fff;border:none;font-size:16px;margin-top:16px
}

.cat-btn{
  position:fixed;right:16px;bottom:80px;
  background:#333;color:#fff;
  padding:10px 14px;border-radius:20px;font-size:14px;cursor:pointer
}

.cat-popup{
  position:fixed;inset:0;background:rgba(0,0,0,.4);display:none
}
.cat-box{
  background:#fff;margin:20% auto;width:80%;
  border-radius:8px;padding:10px
}
.cat-box div{padding:10px;border-bottom:1px solid #eee;cursor:pointer}

input,textarea{
  width:100%;padding:10px;margin-top:6px;font-size:16px
}
.small{font-size:12px;color:#666}
</style>
</head>

<body>

<!-- PAGE 1: RESTAURANTS -->
<div id="page-restaurants" class="page active">
  <div class="header">
    <img src="company-logo.png">
  </div>
  <div class="content">
    <input class="search" placeholder="Search restaurant..." oninput="filterRestaurants(this.value)">
    <div id="restaurantList"></div>
  </div>
</div>

<!-- PAGE 2: MENU -->
<div id="page-menu" class="page">
  <div class="topbar" onclick="backToRestaurants()">← Back</div>
  <div class="header"><img src="company-logo.png"></div>
  <div class="content">
    <h2 id="menuTitle"></h2>
    <div id="menuItems"></div>
  </div>
  <div class="cat-btn" onclick="openCats()">☰ Categories</div>
</div>

<div id="catPopup" class="cat-popup" onclick="closeCats()">
  <div class="cat-box" onclick="event.stopPropagation()" id="catList"></div>
</div>

<!-- PAGE 3: ORDER SUMMARY -->
<div id="page-summary" class="page">
  <div class="topbar" onclick="goBack()">← Back</div>
  <div class="header"><img src="company-logo.png"></div>
  <div class="content">
    <h2>Order Summary</h2>
    <div id="summaryItems"></div>

    <div class="bill">
      <div><span>Item Total</span><span id="itemTotal">₹0</span></div>
      <div><span>Delivery Charge</span><span id="deliveryCharge">₹0</span></div>
      <div class="total"><span>Total Payable</span><span id="grandTotal">₹0</span></div>
    </div>

    <div class="note">
      Delivery charges apply up to 2.5 km. May vary for longer distances.
    </div>

    <button class="primary" onclick="goToAddress()">Continue → Address</button>
  </div>
</div>

  <script>
/* ================= TIME ================= */
function toMin(t){
  if(!t || !t.includes(":")) return null;
  const [h,m]=t.split(":").map(Number);
  return h*60+m;
}
function nowMin(){
  const d=new Date();
  return d.getHours()*60+d.getMinutes();
}
function status(r){
  if(!r.slots || r.slots.length===0){
    return { open:false, opens:"N/A" };
  }

  const n = nowMin();

  for(const s of r.slots){
    const start = toMin(s[0]);
    const end   = toMin(s[1]);
    if(start===null || end===null) continue;

    if(n >= start && n <= end){
      return { open:true, closes:s[1] };
    }
    if(n < start){
      return { open:false, opens:s[0] };
    }
  }
  return { open:false, opens:r.slots[0][0] };
}

/* ================= NAVIGATION ================= */
function show(p){
  document.querySelectorAll(".page").forEach(x=>x.classList.remove("active"));
  document.getElementById(p).classList.add("active");
}
function nav(p){ stack.push(p); show(p); }
function goBack(){ stack.pop(); show(stack.at(-1)); }
function backToRestaurants(){
  cart={}; updateBar();
  stack=["page-restaurants"];
  show("page-restaurants");
}

/* ================= RESTAURANTS ================= */
function renderRestaurants(){
  restaurantList.innerHTML = "";

  const openList = [];
  const closedList = [];

  restaurants.forEach(r=>{
    const s = status(r);

    const d = document.createElement("div");
    d.className = "restaurant " + (s.open ? "open" : "closed");

    d.innerHTML = `
      <img src="${r.logo}">
      <div class="rest-info">
        <div class="rest-name">${r.name}</div>
        <div class="rest-status ${s.open ? "open-text" : "closed-text"}">
          ${s.open ? "Open • Closes " + s.closes : "Closed • Opens " + s.opens}
        </div>
      </div>
    `;

    if(s.open){
      d.onclick = () => openMenu(r.id);
    }

    (s.open ? openList : closedList).push(d);
  });

  [...openList, ...closedList].forEach(el=>restaurantList.appendChild(el));
}

setInterval(renderRestaurants,60000);

/* ================= MENU ================= */
function openMenu(id){
  cart={};
  const r=restaurants.find(x=>x.id===id);
  if(!r) return;
  currentRestaurant=id;
  menuTitle.innerText=r.name;
  renderMenu();
  nav("page-menu");
}

function renderMenu(){
  menuItems.innerHTML="";
  catList.innerHTML="";
  const r=restaurants.find(x=>x.id===currentRestaurant);
  if(!r) return;

  const cats=categories
    .filter(c=>c.RestaurantID===r.id && c.IsActive)
    .sort((a,b)=>(a.SortOrder||0)-(b.SortOrder||0));

  cats.forEach(c=>{
    menuItems.innerHTML+=`<div class="category" id="cat-${c.CategoryID}">${c.CategoryName}</div>`;
    catList.innerHTML+=`<div onclick="scrollCat('${c.CategoryID}')">${c.CategoryName}</div>`;

    items.filter(i=>
      i.RestaurantID===r.id &&
      i.CategoryID===c.CategoryID &&
      i.IsAvailable
    ).forEach(i=>{
      const q=cart[i.ItemName]||0;
      menuItems.innerHTML+=`
        <div class="item">
          <div>
            <div class="item-name">${i.ItemName}</div>
            ${i.ItemDescription?`<div class="item-desc">${i.ItemDescription}</div>`:""}
            <div class="small">₹${i.Price}</div>
          </div>
          <div class="qty">
            <button onclick="upd('${i.ItemName}',-1)">−</button>
            <span>${q}</span>
            <button onclick="upd('${i.ItemName}',1)">+</button>
          </div>
        </div>`;
    });
  });
  updateBar();
}

/* ================= CATEGORY POPUP ================= */
function openCats(){ catPopup.style.display="block"; }
function closeCats(){ catPopup.style.display="none"; }
function scrollCat(id){
  document.getElementById("cat-"+id)?.scrollIntoView({behavior:"smooth"});
  closeCats();
}

/* ================= CART ================= */
function upd(n,d){
  cart[n]=(cart[n]||0)+d;
  if(cart[n]<=0) delete cart[n];
  if(stack.at(-1)==="page-menu") renderMenu();
  if(stack.at(-1)==="page-summary") renderSummary();
  updateBar();
}
function price(n){
  const r=restaurants.find(x=>x.id===currentRestaurant);
  const i=items.find(x=>x.RestaurantID===r.id && x.ItemName===n);
  return i?Number(i.Price):0;
}
function updateBar(){
  let it=0,t=0;
  for(const i in cart){ it+=cart[i]; t+=cart[i]*price(i); }
  if(it>0 && stack.at(-1)==="page-menu"){
    cartBar.style.display="flex";
    cartInfo.innerText=`${it} items | ₹${t}`;
  }else cartBar.style.display="none";
}
function openSummary(){ renderSummary(); nav("page-summary"); }
function renderSummary(){
  summaryItems.innerHTML="";
  let t=0;
  for(const i in cart){
    const p=price(i); t+=cart[i]*p;
    summaryItems.innerHTML+=`
      <div class="cart-item">
        <div>${i}<div class="small">₹${p}</div></div>
        <div class="qty">
          <button onclick="upd('${i}',-1)">−</button>
          <span>${cart[i]}</span>
          <button onclick="upd('${i}',1)">+</button>
        </div>
      </div>`;
  }
  const d=delivery(t);
  itemTotal.innerText=`₹${t}`;
  deliveryCharge.innerText=`₹${d}`;
  grandTotal.innerText=`₹${t+d}`;
}

/* ================= DELIVERY RULE ================= */
function delivery(t){
  if(t<=0) return 0;
  if(t>=1199) return 1;
  if(t>=999) return 9;
  if(t>=799) return 19;
  if(t>=599) return 29;
  if(t>=399) return 39;
  return 49;
}

/* ================= ADDRESS ================= */
function goToAddress(){
  let t=0; for(const i in cart) t+=cart[i]*price(i);
  if(t<99){ alert("Minimum order ₹99"); return; }
  nav("page-address");
}
function captureLocation(){
  navigator.geolocation.getCurrentPosition(p=>{
    lat=p.coords.latitude; lng=p.coords.longitude;
    mapLink=`https://maps.google.com/?q=${lat},${lng}`;
    locStatus.innerText="Location captured ✓";
  },()=>alert("Location required"));
}

/* ================= PLACE ORDER ================= */
function placeOrder(){
  let t=0; for(const i in cart) t+=cart[i]*price(i);
  if(t<99){ alert("Minimum order ₹99"); return; }

  const n=custName.value.trim();
  if(!/^[A-Za-z ]{5,25}$/.test(n)){ alert("Enter valid name"); return; }

  const ph=custPhone.value.trim();
  if(!/^[0-9]{10}$/.test(ph)){ alert("Invalid phone"); return; }

  const a=custAddress.value.trim();
  if(a.length<15){ alert("Enter full address"); return; }

  const manual=document.getElementById("manualMapLink").value.trim();
  if(!mapLink && !manual){ alert("Location required"); return; }

  const loc=mapLink||manual;

  let txt=`20nagar Food Xpress\nRestaurant: ${restaurants.find(r=>r.id===currentRestaurant).name}\n\nItems:\n`;
  for(const i in cart){ txt+=`${i} × ${cart[i]} = ₹${cart[i]*price(i)}\n`; }
  const d=delivery(t);
  txt+=`\nItem Total: ₹${t}\nDelivery: ₹${d}\nTotal: ₹${t+d}\n\n${n}\n${ph}\n${a}\n${loc}`;

  navigator.clipboard.writeText(txt);
  setTimeout(()=>{ location.href="https://wa.me/919484818194?text="+encodeURIComponent(txt); },200);
}
</script>
</body>
</html>
