<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>20nagar Food Xpress</title>

<style>
body{font-family:Arial;margin:0;padding:16px;max-width:900px;margin:auto}
h1{text-align:center;margin-bottom:4px}
.tagline{text-align:center;color:#666;margin-bottom:12px}
input,button{width:100%;padding:10px;margin:6px 0;font-size:15px}
button{background:#d62828;color:#fff;border:none;border-radius:8px}
.rest{border:1px solid #ddd;padding:12px;border-radius:8px;margin-bottom:10px}
.qty{display:flex;align-items:center;gap:10px}
.qty button{width:40px}
.hidden{display:none}
.small{color:#666;font-size:13px}
.total-row{display:flex;justify-content:space-between;margin-top:6px}
.error{color:red;font-size:13px}
</style>

<script>
let RESTS=[], MENU=[], CART={}, currentRest=null, userLocation='';

function init(){
  google.script.run.withSuccessHandler(r=>{
    RESTS=r||[];
    renderRestaurants();
  }).getRestaurants();
}

function renderRestaurants(){
  const box=document.getElementById('restaurants');
  box.innerHTML='';
  RESTS.forEach(r=>{
    box.innerHTML+=`
      <div class="rest">
        <b>${r.name}</b><br>
        <span class="small">${r.address}</span><br><br>
        <button onclick="openMenu('${r.restaurant_id}')">Open Menu</button>
      </div>`;
  });
}

function openMenu(id){
  currentRest=RESTS.find(r=>r.restaurant_id===id);
  document.getElementById('page-rest').classList.add('hidden');
  document.getElementById('page-menu').classList.remove('hidden');
  document.getElementById('rest-name').innerText=currentRest.name;
  google.script.run.withSuccessHandler(m=>{
    MENU=m||[]; CART={}; renderMenu();
  }).getMenuForRestaurant(id);
}

function renderMenu(){
  const box=document.getElementById('menu');
  box.innerHTML='';
  MENU.forEach(i=>{
    box.innerHTML+=`
      <div class="rest">
        <b>${i.item_name}</b> ₹${i.price}
        <div class="qty">
          <button onclick="chg('${i.menu_id}',-1)">−</button>
          <span id="q_${i.menu_id}">0</span>
          <button onclick="chg('${i.menu_id}',1)">+</button>
        </div>
      </div>`;
  });
}

function chg(id,d){
  if(!CART[id]) CART[id]={qty:0};
  CART[id].qty+=d;
  if(CART[id].qty<0) CART[id].qty=0;
  document.getElementById('q_'+id).innerText=CART[id].qty;
  recalc();
}

function recalc(){
  let sub=0;
  MENU.forEach(i=>{
    if(CART[i.menu_id]) sub+=CART[i.menu_id].qty*i.price;
  });
  document.getElementById('sub').innerText=sub;
  google.script.run.withSuccessHandler(dc=>{
    document.getElementById('del').innerText=dc;
    document.getElementById('tot').innerText=sub+dc;
  }).getDeliveryChargeForClient(sub,2.5);
}

function getLocation(){
  navigator.geolocation.getCurrentPosition(p=>{
    userLocation=`https://maps.google.com/?q=${p.coords.latitude},${p.coords.longitude}`;
    document.getElementById('locStatus').innerText='Location captured';
  },()=>alert('Location required'));
}

function checkout(){
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const addr=document.getElementById('addr').value.trim();

  if(!/^[A-Za-z ]{10,}$/.test(name)) return alert('Name invalid');
  if(!/^[0-9]{10}$/.test(phone)) return alert('Phone invalid');
  if(addr.length<15||addr.length>100) return alert('Address invalid');
  if(!userLocation) return alert('Location required');

  let msg=`*Order - ${currentRest.name}*\n\n`;
  let sub=0;
  MENU.forEach(i=>{
    if(CART[i.menu_id]&&CART[i.menu_id].qty>0){
      let t=CART[i.menu_id].qty*i.price;
      sub+=t;
      msg+=`${CART[i.menu_id].qty} x ${i.item_name} = ₹${t}\n`;
    }
  });
  msg+=`\nSubtotal: ₹${sub}\n`;
  msg+=`Address: ${addr}\nLocation: ${userLocation}`;

  google.script.run.withSuccessHandler(s=>{
    window.location.href=`https://wa.me/${s.whatsapp_number}?text=`+encodeURIComponent(msg);
  }).getSettings();
}

window.onload=init;
</script>
</head>

<body>
<h1>20nagar Food Xpress</h1>
<div class="tagline">Fast Delivery • Best Prices</div>

<div id="page-rest">
  <div id="restaurants"></div>
</div>

<div id="page-menu" class="hidden">
  <h2 id="rest-name"></h2>
  <div id="menu"></div>

  <div class="total-row"><span>Subtotal</span><span>₹<span id="sub">0</span></span></div>
  <div class="total-row"><span>Delivery</span><span>₹<span id="del">0</span></span></div>
  <div class="total-row"><b>Total</b><b>₹<span id="tot">0</span></b></div>

  <input id="name" placeholder="Full name">
  <input id="phone" placeholder="10-digit phone">
  <input id="addr" placeholder="Full address">

  <button onclick="getLocation()">Get Location</button>
  <div id="locStatus" class="small"></div>

  <button onclick="checkout()">Order on WhatsApp</button>
</div>
</body>
</html>
